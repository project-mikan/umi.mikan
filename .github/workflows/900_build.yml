name: „Äêdeploy„Äëbuild

on:
  pull_request:
    branches:
      - main
    types: [closed]
    paths:
      - "backend/**"
      - "frontend/**"
      - ".github/**"
      - "infra/prod/**"

jobs:
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - name: Build and Push Backend
        uses: ./.github/workflows/_docker_build.yml
        with:
          service: backend
          github-token: ${{ secrets.GITHUB_TOKEN }}

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - name: Build and Push Frontend
        uses: ./.github/workflows/_docker_build.yml
        with:
          service: frontend
          github-token: ${{ secrets.GITHUB_TOKEN }}

  build-scheduler:
    name: Build Scheduler
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - name: Build and Push Scheduler
        uses: ./.github/workflows/_docker_build.yml
        with:
          service: scheduler
          github-token: ${{ secrets.GITHUB_TOKEN }}

  build-subscriber:
    name: Build Subscriber
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - name: Build and Push Subscriber
        uses: ./.github/workflows/_docker_build.yml
        with:
          service: subscriber
          github-token: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend, build-scheduler, build-subscriber]
    if: always()
    steps:
      - name: Send Discord notification
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.NOTIFY_DISCORD_WEBHOOK }}
          title: "üê≥ Docker Build Notification"
          description: |
            **PR**: ${{ github.event.pull_request.title }}
            **Author**: ${{ github.event.pull_request.user.login }}
            **Status**: ${{ (needs.build-backend.result == 'success') && (needs.build-frontend.result == 'success') && (needs.build-scheduler.result == 'success') && (needs.build-subscriber.result == 'success') && '‚úÖ All Docker images built successfully!' || '‚ùå Docker build failed' }}

            **Images Built**: backend, frontend, scheduler, subscriber
          color: ${{ (needs.build-backend.result == 'success') && (needs.build-frontend.result == 'success') && (needs.build-scheduler.result == 'success') && (needs.build-subscriber.result == 'success') && '3066993' || '15158332' }}
          url: ${{ github.event.pull_request.html_url }}
          username: "GitHub Actions"
          avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
