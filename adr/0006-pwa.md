# ADR-0006: Progressive Web App (PWA) Implementation

## Status

Proposed

## Context

umi.mikanは日記アプリケーションとして、ユーザーがより日常的に使いやすい環境を提供する必要があります。現在のWebアプリケーションにPWA機能を追加することで以下の課題を解決できます：

- モバイルデバイスでのアプリライクな体験
- オフライン環境での基本機能利用
- ホーム画面へのインストール機能
- プッシュ通知（将来的）
- より高速なアプリケーション起動

## Decision

SvelteKit フロントエンドにPWA機能を実装し、日記アプリとしての利便性を向上させます。

### Architecture

```
Frontend (SvelteKit) + PWA
    ↓
Service Worker (Cache Strategy)
    ↓
Static Assets + API Cache
    ↓
Offline Fallback Pages
```

### Implementation Plan

#### 1. 依存関係とツール

- **@vite-pwa/sveltekit**: SvelteKit用PWAプラグイン
- **Vite PWA**: ビルド時のService Worker生成
- **Workbox**: Service Worker戦略の実装

#### 2. キャッシュ戦略

##### Static Assets

- **戦略**: CacheFirst
- **対象**: CSS, JS, Images, Fonts
- **期間**: 1年（リビジョン管理）

##### API Responses

- **戦略**: NetworkFirst (フォールバック: Cache)
- **対象**:
  - 日記一覧 (`/DiaryService/GetDiaryEntries`)
  - ユーザー情報 (`/AuthService/GetUserInfo`)
- **期間**: 1時間

##### Dynamic Content

- **戦略**: StaleWhileRevalidate
- **対象**: 日記詳細、検索結果
- **期間**: 30分

#### 3. アプリマニフェスト設定

```json
{
  "name": "umi.mikan - 日記アプリ",
  "short_name": "umi.mikan",
  "description": "毎日使う日記アプリ",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#3b82f6",
  "orientation": "portrait-primary",
  "categories": ["lifestyle", "productivity"],
  "lang": "ja"
}
```

#### 4. アイコン仕様

- **Adaptive Icons**: 192x192, 512x512 (maskable)
- **Legacy Icons**: 72x72, 96x96, 128x128, 144x144, 152x152, 384x384
- **Apple Touch Icon**: 180x180
- **Favicon**: 32x32, 16x16

#### 5. オフライン機能

##### 利用可能な機能

- 既にキャッシュされた日記の閲覧
- アプリのナビゲーション
- ダークモード切り替え
- 言語設定変更

##### 制限される機能

- 新規日記作成
- 日記編集・削除
- AI要約機能
- 検索機能（新規）

##### オフライン表示

- カスタムオフラインページ
- 制限機能の説明
- 接続復旧時の自動同期案内

#### 6. ユーザー体験

##### インストールプロンプト

- 3回以上の訪問後に表示
- 日本語・英語の多言語対応
- ユーザー選択の記憶（3ヶ月）

##### 更新通知

- Service Worker更新時の通知
- 「再読み込みして最新版を使用」ボタン
- バックグラウンド更新

#### 7. 国際化対応

- マニフェストの多言語設定
- 既存i18n（svelte-i18n）との統合
- オフラインページの翻訳対応

### File Structure

```
frontend/
├── static/
│   ├── icons/
│   │   ├── icon-72x72.png
│   │   ├── icon-96x96.png
│   │   ├── ...
│   │   └── icon-512x512.png
│   ├── apple-touch-icon.png
│   └── favicon.ico
├── src/
│   ├── routes/
│   │   └── offline/
│   │       └── +page.svelte
│   ├── lib/
│   │   └── components/
│   │       ├── PWAInstallPrompt.svelte
│   │       └── PWAUpdateNotification.svelte
│   └── app.html (PWA meta tags追加)
└── vite.config.ts (VitePWA設定)
```

### Configuration

#### Vite PWA設定

```typescript
VitePWA({
  registerType: "autoUpdate",
  workbox: {
    globPatterns: ["**/*.{js,css,html,ico,png,svg}"],
    runtimeCaching: [
      {
        urlPattern: /^https:\/\/localhost:2001\/.*$/,
        handler: "NetworkFirst",
        options: {
          cacheName: "api-cache",
          cacheableResponse: { statuses: [0, 200] },
        },
      },
    ],
  },
  manifest: {
    // 上記マニフェスト設定
  },
});
```

## Consequences

### Positive

- **ユーザー体験向上**: アプリライクな操作感
- **アクセシビリティ**: オフライン環境での基本機能利用
- **パフォーマンス**: キャッシュによる高速読み込み
- **エンゲージメント**: ホーム画面インストールによる利用頻度向上
- **モバイル最適化**: スマートフォンでの使いやすさ

### Negative

- **複雑性**: Service Workerの管理とデバッグ
- **キャッシュ管理**: ストレージ使用量の増加
- **開発コスト**: PWA固有の実装とテスト工数
- **ブラウザ対応**: 一部ブラウザでの機能制限

### Risks

- Service Worker の誤動作によるアプリ障害
- キャッシュ戦略ミスによるデータ不整合
- iOSでのPWA制限（Safari依存）
- セキュリティ要件（HTTPS必須）

## Implementation Notes

### Phase 1: 基本PWA機能

1. @vite-pwa/sveltekit インストール
2. 基本的なService Worker設定
3. アプリマニフェスト作成
4. アイコン生成とHTMLメタタグ追加

### Phase 2: キャッシュ戦略

1. 静的アセットのキャッシュ
2. API レスポンスキャッシュ
3. オフラインページ実装

### Phase 3: UX改善

1. インストールプロンプト
2. 更新通知機能
3. 多言語対応

### Phase 4: 最適化

1. Lighthouse PWAスコア改善
2. パフォーマンス測定と調整
3. クロスブラウザテスト

### 検証項目

- [ ] Lighthouse PWAスコア90以上
- [ ] オフライン機能テスト
- [ ] インストール機能テスト（Android/iOS）
- [ ] キャッシュ戦略の検証
- [ ] 多言語対応の確認
- [ ] Service Worker更新フローの確認

### 今後の展開

- プッシュ通知機能の実装
- バックグラウンド同期
- より高度なオフライン機能
- PWA専用機能の活用
